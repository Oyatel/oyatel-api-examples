<html>
<head>

<script type="text/javascript" src="http://code.jquery.com/jquery-1.5.1.js"></script>  
<script type="text/javascript" src="js/cometd.js"></script>
<script type="text/javascript" src="js/jquery.cometd.js"></script>
<script type="text/javascript" src="js/jquery.cookie.js"></script>
<script type="text/javascript" src="js/jquery.json-2.2.js"></script>
<script type="text/javascript" src="js/jquery.jsonp-2.1.4.min.js"></script>
<script type="text/javascript" src="js/oyatelapi.js"></script>
<script type="text/javascript" src="js/Oyatel.js"></script>

<style>
	#connect .authorized {
		display: none;
	}
	
	.btn-oyatel-login {
		cursor: pointer;
		width: 156px;
		height: 24px;
		background: url('img/connect_with_oyatel-156-24.png') no-repeat;
	}
	
	.btn-oyatel-login span {
		display: none;
	}
</style>
</head>
<body>

<div id="connect">
	<div class="not-authorized">
		<div class="btn-oyatel-login"><span>Connect with Oyatel</span></div>
	</div>
	<div class="authorized">
		Logged in as: <span class="oyatel-username"></span> <button class="oyatel-logout">Logout</button>
	</div>
	<div class="testJacek" style="display:none;">
		Presence package... <span class="testUserData"></span>
	</div>
</div>

<div id="call_events">
	<h1>Call Events</h1>
</div>



<script type="text/javascript">

$(document).ready(function() {
	Oyatel.init('211744cd-890f-448f-9d08-f51966115308', 'http://localhost/~jaceklawniczak/gitProject/oyatel-api-examples/javascript/oauth_cb.html');
	
	// Setup callbacks for deauth/auth-orization
	Oyatel.bind('authorized', function() {
		console.log('onAuthorized callback called');
		authorized();
	});
	Oyatel.bind('authorizationfailed', function(errormsg) {
		console.log('The user rejected the authorization, or some error occured: ' + errormsg);
	});
	
	Oyatel.bind('deauthorized', function() {
		console.log('onDeauthorized callback called');
		deauthorized();
	});
	
	Oyatel.checkAuthorization();
	
	// setup GUI to show we are authorized and start listening to events
	function authorized() {
		console.log('calling authorized');
		
		$('#connect .authorized').css('display', 'block');
		$('#connect .not-authorized').css('display', 'none');
		
		

		
		// get ME info...
		Oyatel.User.currentUser(function(user) {
			$('.oyatel-username').html(user.username + ' (' + user.firstname + ' ' + user.lastname + ')');
		});
		
		Oyatel.Events.subscribe('/events/call', function(msg) {
			// add call info to the output...
			
			var string = "";
			if (msg.data.direction == "out") {
				string = "User " + msg.data.userId + " calls " + msg.data.destination + " from " + msg.data.callerId.number + ". Current call state is: " + msg.data.event;
			} else {
				string = "User " + msg.data.userId + " receives call from from " + msg.data.callerId.number + ". Current call state is: " + msg.data.event;
			}
			var dataString = '<div class="callevent">' + string + '</div>';
			$('#call_events').append(dataString);
			console.log("Got call package: ", msg.data);
		});	
	
		Oyatel.Events.subscribe('/events/presence', function(msg) {
			console.log('Got presence package: ', msg.data);
			$('#connect .jacekTest').css('display', 'block');
		});
		
	}
			
	// setup GUI to show we are not authorized
	function deauthorized() {
		$('#connect .authorized').css('display', 'none');
		$('#connect .not-authorized').css('display', 'block');
	}
	
	// $.Oyatel.Login.createButton('.btn-oyatel-login', 'normal');
	
	$('.btn-oyatel-login').click(function() {
		Oyatel.authorize();
	});
	$('.oyatel-logout').click(function() {
		Oyatel.deauthorize();
	});
	
});

</script>

</body>
</html>