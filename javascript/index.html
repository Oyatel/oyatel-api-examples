<html>
<head>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
<script type="text/javascript" src="https://api.oyatel.com/cometd/jquery/jquery.json-2.2.js"></script>
<script type="text/javascript" src="js/jquery.cookie.js"></script>
<script type="text/javascript" src="https://api.oyatel.com/cometd/org/cometd.js"></script>
<script type="text/javascript" src="https://api.oyatel.com/cometd/jquery/jquery.cometd.js"></script>
<script type="text/javascript" src="https://api.oyatel.com/cometd/oyatelapi.js"></script>
<script type="text/javascript" src="jslib/OyatelApi.js"></script>

<style>
	#connect .authorized {
		display: none;
	}
	
	.btn-oyatel-login {
		cursor: pointer;
		width: 156px;
		height: 24px;
		background: url('img/connect_with_oyatel-156-24.png') no-repeat;
	}
	
	.btn-oyatel-login span {
		display: none;
	}
</style>
</head>
<body>

<div id="connect">
	<div class="not-authorized">
		<div class="btn-oyatel-login"><span>Connect with Oyatel</span></div>
	</div>
	<div class="authorized">
		Logged in as: <span class="oyatel-username"></span> <button class="oyatel-logout">Logout</button>
	</div>
</div>

<div id="call_events">
	<h1>Call Events</h1>
</div>



<script type="text/javascript">

$(document).ready(function() {
	Oyatel.init('558f6868-0a98-45db-ab57-35173f4ec960', 'http://127.0.01/~even/js-api-example/oauth_cb.html');
	
	// Setup callbacks for deauth/auth-orization
	Oyatel.onAuthorized = function() {
		console.log('onAuthorized callback called');
		authorized();
	};
	Oyatel.onDeauthorized = function() {
		console.log('onDeauthorized callback called');
		deauthorized();
	};
	
	if (Oyatel.isAuthorized()) {
		authorized();
	} else {
		deauthorized();
	}
	
	// setup GUI to show we are authorized and start listening to events
	function authorized() {
		$('#connect .authorized').css('display', 'block');
		$('#connect .not-authorized').css('display', 'none');
		
		// get ME info...
		Oyatel.User.currentUser(function(user) {
			$('.oyatel-username').html(user.username + ' (' + user.firstname + ' ' + user.lastname + ')');
		});
		
		// ? Oyatel.Events.clearListeners();
		Oyatel.Events.subscribe('/events/call', function(msg) {
			// add call info to the output...
			var dataString = [
				'<div class="callevent">',
				msg.data.direction == "out" ? "Outgoing Call from (destination TODO)" : "Incoming Call from ",
				msg.data.callerId.number,
				'</div>'
			];
			$('#call_events').append(dataString.join(''));
		});	
		
		Oyatel.Events.subscribe('/events/presence', function(msg) {
			console.log('Got presence package: ', msg);
		});
	}
	
	// setup GUI to show we are not authorized
	function deauthorized() {
		$('#connect .authorized').css('display', 'none');
		$('#connect .not-authorized').css('display', 'block');
	}
	
	$('.btn-oyatel-login').click(function() {
		Oyatel.authorize();
	});
	$('.oyatel-logout').click(function() {
		Oyatel.deauthorize();
	});
	
});

</script>

</body>
</html>